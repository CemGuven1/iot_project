{% extends "master.html" %}
{% block content %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


<!-- Include Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">


<!-- Buttons with Icons -->
<div class="button-container">
    <button id="toggleAccelChart" class="button">
        <i class="fas fa-chart-line"></i> Hide Acceleration Chart
    </button>

    <button id="toggleGyroChart" class="button">
        <i class="fas fa-tachometer-alt"></i> Hide Gyro Chart
    </button>

    <button id="toggleTempChart" class="button">
        <i class="fas fa-thermometer-half"></i> Hide Temperature Chart
    </button>

    <button id="toggleBatteryChart" class="button">
        <i class="fas fa-battery-half"></i> Hide Battery Chart
    </button>
</div>


<div class="accordion-container">
    <button class="accordion">Toggle Chart Options</button>
    <div class="panel">
        <label><input type="checkbox" id="toggle-accel-x" checked> Acceleration X</label><br>
        <label><input type="checkbox" id="toggle-accel-y" checked> Acceleration Y</label><br>
        <label><input type="checkbox" id="toggle-accel-z" checked> Acceleration Z</label><br>
        <label><input type="checkbox" id="toggle-gyro-x" checked> Gyro X</label><br>
        <label><input type="checkbox" id="toggle-gyro-y" checked> Gyro Y</label><br>
        <label><input type="checkbox" id="toggle-gyro-z" checked> Gyro Z</label><br>
        <label><input type="checkbox" id="toggle-temp" checked> Temperature</label><br>
        <label><input type="checkbox" id="toggle-battery" checked> Battery</label><br>
    </div>
</div>



<!-- Chart Containers -->
<div id="accelChartContainer">
    <canvas id="AccelChart"></canvas>
</div>


<div id="gyroChartContainer">
    <canvas id="GyroChart"></canvas>
</div>


<div id="tempChartContainer">
    <canvas id="TempChart"></canvas>
</div>


<div id="batteryChartContainer">
    <canvas id="BatteryChart"></canvas>
</div>



<script>

// Initialize variables to track the last timestamp drawn on each chart 
let lastUpdateTimestamp = null;
const maxDataPoints = 20;  // Maximum number of data points to display

// Function to fetch and update the chart with the latest device data
function fetchLatestData() {
    console.log("Last update timestamp:", lastUpdateTimestamp);
    
    const deviceId = "{{ device.device_id }}";
    fetch(`/app/device/${deviceId}/latest-data/`)
    .then(response => response.json())
    .then(data => {
        if (!data.error) {
            const allData = data.all_data;

            // Filter data to include only entries with timestamps greater than the last drawn one
            const newData = allData.filter(entry => {
                const entryTimestamp = new Date(entry.timestamp);
                return (lastUpdateTimestamp == null || entryTimestamp > lastUpdateTimestamp);
            });

            // Check if there's any new data
            if (newData.length > 0) {
                // Reverse the order of the fetched data so the oldest comes first
                newData.reverse().forEach(entry => {
                    // Add timestamps to labels
                    AccelChart.data.labels.push(formatTimestamp(entry.timestamp));

                    // Add data to datasets
                    AccelChart.data.datasets[0].data.push(entry.acceleration_x);
                    AccelChart.data.datasets[1].data.push(entry.acceleration_y);
                    AccelChart.data.datasets[2].data.push(entry.acceleration_z);

                    GyroChart.data.labels.push(formatTimestamp(entry.timestamp));
                    GyroChart.data.datasets[0].data.push(entry.gyro_x);
                    GyroChart.data.datasets[1].data.push(entry.gyro_y);
                    GyroChart.data.datasets[2].data.push(entry.gyro_z);

                    TempChart.data.labels.push(formatTimestamp(entry.timestamp));
                    TempChart.data.datasets[0].data.push(entry.temperature);

                    BatteryChart.data.labels.push(formatTimestamp(entry.timestamp));
                    BatteryChart.data.datasets[0].data.push(entry.battery);
                });

                // Limit data points to the last 20
                limitChartData(AccelChart);
                limitChartData(GyroChart);
                limitChartData(TempChart);
                limitChartData(BatteryChart);

                // Update charts
                AccelChart.update();
                GyroChart.update();
                TempChart.update();
                BatteryChart.update();

                // Update lastUpdateTimestamp only after processing new data
                lastUpdateTimestamp = new Date(newData[newData.length - 1].timestamp);
                console.log("Updated last update timestamp:", lastUpdateTimestamp);
            } else {
                console.log("No new data to update.");
            }
        } else {
            console.error(data.error);
        }
    })
    .catch(error => console.error('Error fetching latest data:', error));
}


// Set an interval to automatically fetch data every 5 seconds (5000 ms)
setInterval(fetchLatestData, 5000);

// Fetch the data immediately when the page loads
document.addEventListener('DOMContentLoaded', fetchLatestData);

</script>


{% endblock %}
